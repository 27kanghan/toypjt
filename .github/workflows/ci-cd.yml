# 1. ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: CI/CD Pipeline for Spring Boot

# 2. ì‹¤í–‰ ì‹œì 
on:
  push:
    branches: [ "main" ]

# 3. ì‹¤í–‰í•  ì‘ì—…ë“¤
jobs:
  #######################
  # 1. CI (ë¹Œë“œ/í…ŒìŠ¤íŠ¸) ì‘ì—…
  #######################
  build:
    runs-on: ubuntu-latest
    steps:
      # (1) ì½”ë“œ ë³µì‚¬
      - uses: actions/checkout@v4

      # (2) JDK 17 ì„¤ì¹˜
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # (3) gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # (4.1) Gradleë¡œ ë¹Œë“œ (testëŠ” ê±´ë„ˆë›°ê¸°)
      - name: Build with Gradle
        run: ./gradlew build -x test

      # (5) ë¹Œë“œëœ .jar íŒŒì¼ì„ GitHub Actionsì— ì—…ë¡œë“œ
      - name: Upload artifact (jar file)
        uses: actions/upload-artifact@v4
        with:
          name: toypjt-jar
          path: build/libs/*.jar
          retention-days: 1

  #######################
  # 2. CD (ë°°í¬) ì‘ì—…
  #######################
  deploy:
    needs: build # 1. 'build' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ ì‘ì—…ì´ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest

    steps:
      # (1) build ì‘ì—…ì´ ì—…ë¡œë“œí•œ .jar íŒŒì¼ì„ 'ë¡œë´‡'ì˜ ì„œë²„ë¡œ ë‹¤ìš´ë¡œë“œ
      - name: Download artifact (jar file)
        uses: actions/download-artifact@v4
        with:
          name: toypjt-jar

      # (2) (ë””ë²„ê¹…ìš©) ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ ëª©ë¡ í™•ì¸
      - name: List files in directory
        run: ls -la

      # (3) 'scp' ë¡œë´‡ì„ ì‚¬ìš©í•´ .jar íŒŒì¼ì„ AWS ì„œë²„ë¡œ "ë³µì‚¬"
      - name: Copy jar file to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "toyPJT-0.0.1-SNAPSHOT.jar" # ğŸ‘ˆ ëŒ€ì†Œë¬¸ì ìˆ˜ì • ì™„ë£Œ
          target: "/home/ubuntu"

      # (4) 'ssh' ë¡œë´‡ì„ ì‚¬ìš©í•´ AWS ì„œë²„ì—ì„œ "ëª…ë ¹ì–´ ì‹¤í–‰"
      - name: Run deploy script on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22

          # (b) "ë³µì‚¬ê°€ ëë‚œ í›„" AWS ì„œë²„ì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
          script: |
            # 1. 'scp' ë¡œë´‡ì´ ë³µì‚¬í•´ ë‘” íŒŒì¼ì„ app.jarë¡œ ì´ë¦„ ë³€ê²½
            mv /home/ubuntu/toyPJT-0.0.1-SNAPSHOT.jar /home/ubuntu/app.jar
            
            # 2. [!!! ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ (ë” ì•ˆì „í•˜ê²Œ) !!!]
            # 'app.jar'ë¥¼ ì‹¤í–‰ ì¤‘ì¸ 'java' í”„ë¡œì„¸ìŠ¤ì˜ PIDë¥¼ ì°¾ì•„ì„œ ì¢…ë£Œ
            PID=$(ps -ef | grep 'java -jar /home/ubuntu/app.jar' | grep -v 'grep' | awk '{print $2}')
            if [ -n "$PID" ]; then
              echo "Killing process: $PID"
              kill -9 $PID
            fi
            
            # 3. ìƒˆ app.jar íŒŒì¼ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰ (ë¡œê·¸ íŒŒì¼ ë‚¨ê¸°ê¸°)
            nohup java -jar /home/ubuntu/app.jar > /home/ubuntu/app.log 2>&1 &
  ```eof
  
  ### ğŸ“Œ ë­ê°€ ë°”ë€Œì—ˆë‚˜ìš”?
  
  `ssh-action`ì˜ `script:` ë¶€ë¶„ì—ì„œ, "ìŠ¤í¬ë¦½íŠ¸ ìì‚´"ì„ ì¼ìœ¼í‚¤ë˜ `pkill` ëª…ë ¹ì–´ë¥¼ **ë” ì•ˆì „í•˜ê³  ì •í™•í•œ** PID ê²€ìƒ‰/ì œê±° ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°”ê¿¨ìŠµë‹ˆë‹¤.
  
  ```bash
  # 2. ê¸°ì¡´ pkill (ìœ„í—˜)
  # pkill -f 'java -jar /home/ubuntu/app.jar' || true
  
  # 2. ìƒˆ ë°©ì‹ (ì•ˆì „)
  PID=$(ps -ef | grep 'java -jar /home/ubuntu/app.jar' | grep -v 'grep' | awk '{print $2}')
  if [ -n "$PID" ]; then
echo "Killing process: $PID"
  kill -9 $PID
  fi